/**
 ****************************************************************************
 * @file	 calc.c
 * @brief	 Calculation Routine Functions
 * @version  V1.0
 *****************************************************************************
 */
#include "ipdefine.h"

#define DEFINE_APP
#include "calc.h"
#undef DEFINE_APP


/*===================================================================*
      Proto Type Definition
 *===================================================================*/
static q31_t muljc(q31_t r1, q31_t c1);
static q31_t E_Sqrt(q31_t data_s);
static int32_t sadd32(int32_t a, int32_t b);



/**
 *********************************************************************************************
 * @brief		Calculation Vdq
 *
 * @param		q15_t	r_vd	Vd
 * @param		q15_t	r_vq	Vq
 *
 * @return		q15_t	Vdq
 *********************************************************************************************
 */
q15_t Cal_Vdq(q15_t r_vd, q15_t r_vq)
{        
    q31_t w_work1;
    q15_t R_temp_0;      // Vdc
    q15_t R_temp_1;      // Vdc_R3
    
    w_work1 = E_Sqrt(sadd32(((r_vd * r_vd ) << 1), ((r_vq * r_vq) << 1)));
    R_temp_0 = w_work1 >> 16;
    R_temp_1 = (muljc(R_temp_0, (FIX_15 * 1732 / 1000))) >> 16;

    return R_temp_1;
}


 /**
 *********************************************************************************************
 * @brief		Calculation Square	Root
 *
 * @param		q31_t	data_s	Target of the square root.
 *
 * @return		q31_t	Result of square root
 *********************************************************************************************
 */
#define Z_SIN_BIT           7
const uint16_t Table_Sqrt[129] = {
        0,   2896,   4096,   5017,   5793,   6476,   7094,   7663,
     8192,   8689,   9159,   9606,  10033,  10443,  10837,  11217,
    11585,  11942,  12288,  12625,  12953,  13273,  13585,  13890,
    14189,  14482,  14768,  15050,  15326,  15597,  15864,  16126,
    16384,  16638,  16888,  17135,  17378,  17618,  17854,  18087,
    18318,  18545,  18770,  18992,  19212,  19429,  19644,  19856,
    20066,  20274,  20480,  20684,  20886,  21085,  21283,  21480,
    21674,  21867,  22058,  22247,  22435,  22621,  22806,  22989,
    23170,  23351,  23530,  23707,  23884,  24059,  24232,  24405,
    24576,  24746,  24915,  25083,  25249,  25415,  25580,  25743,
    25905,  26067,  26227,  26387,  26545,  26703,  26859,  27015,
    27170,  27324,  27477,  27629,  27780,  27931,  28081,  28230,
    28378,  28525,  28672,  28818,  28963,  29108,  29251,  29394,
    29537,  29678,  29819,  29960,  30099,  30238,  30377,  30515,
    30652,  30788,  30924,  31059,  31194,  31328,  31462,  31595,
    31727,  31859,  31991,  32122,  32252,  32382,  32511,  32640,
    32768
};

static q31_t E_Sqrt(q31_t data_s)
{
    uint32_t temp1 = 0;
    uint32_t temp2 = 0;
    uint32_t acc1 = 0;
    uint32_t acc41 = 0;
    uint32_t acc42 = 0;
    uint32_t acc43 = 0;

    temp1 = data_s;
    temp2 = 1;

    if (data_s < (FIX_31 / 4)) {
        temp1 = data_s * 4;
        temp2 = 2;
    }
    if (data_s < (FIX_31 / 16)) {
        temp1 = data_s * 16;
        temp2 = 4;
    }
    if (data_s < (FIX_31 / 64)) {
        temp1 = data_s * 64;
        temp2 = 8;
    }
    if (data_s < (FIX_31 / 256)) {
        temp1 = data_s * 256;
        temp2 = 16;
    }
    if (data_s < (FIX_31 / 1024)) {
        temp1 = data_s * 1024;
        temp2 = 32;
    }
    if (data_s < (FIX_31 / 4096)) {
        temp1 = data_s * 4096;
        temp2 = 64;
    }

    acc1 = (temp1 >> (32 - Z_SIN_BIT - 1));
    acc43 = temp1 % (FIX_31 / (1 << Z_SIN_BIT));
    acc41 = Table_Sqrt[acc1];
    acc42 = Table_Sqrt[acc1 + 1];

    return ((acc41 + ((acc42 - acc41) * acc43) / (FIX_31 / (1 << Z_SIN_BIT))) / temp2) << 16;
}


 /**
 *********************************************************************************************
 * @brief		Calculation Multiply
 *
 * @param		int32_t	r1	multiply parameter
 * @param		int32_t	c1	multiply parameter
 *
 * @return		int32_t	Result of multiply
 *********************************************************************************************
 */
static int32_t	muljc(int32_t r1, int32_t c1){

	int32_t		tempm = 0,n = 0;

	n=0;
	while	( (c1>>n) >= (256*128) ){
		n = n+1;
	}

	tempm = r1 * (c1 >> n);	
/*
	if	( tempm >= (2147483647 >> (n+1)) ){	
		tempm = (2147483647 >> (n+1));
	}
	if	( tempm < (-2147483648 >> (n+1)) ){	
		tempm = (-2147483648 >> (n+1));
	}
*/
	return	tempm << (n+1);	
}


 /**
 *********************************************************************************************
 * @brief		Add with Saturation
 *
 * @param		int32_t	r1	add parameter
 * @param		int32_t	c1	add parameter
 *
 * @return		int32_t	Result of add with saturation
 *********************************************************************************************
 */
static int32_t sadd32(int32_t a, int32_t b)
{
    int32_t c = a + b;

    if (a > 0 && b > 0 && c < 0) {
        c = 0x7fffffff;
    }
    else if (a < 0 && b < 0 && c > 0) {
        c = 0x80000000;
    }
    return c;
}

/*************************** END OF FILE **************************************/
